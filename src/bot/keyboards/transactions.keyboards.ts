import TelegramBot from 'node-telegram-bot-api';
import { PaymentStatusEnum, UserLanguageEnum } from 'src/helper';
import { Payment } from 'src/payment/payment.entity';
import { PaymentService } from 'src/payment/payment.service';
import { User } from 'src/user/user.entity';

export const sendTransactionsKeyboard = async (
  id: number,
  bot: TelegramBot,
  user: User,
  paymentService: PaymentService,
  isAdminPanel: boolean,
  language: UserLanguageEnum,
) => {
  const { payments, total } = await paymentService.getPayments({
    user_id: user.id,
  });

  let text;

  if (payments.length) {
    text = `üóÑÔ∏è ${getUserInfoText(language, isAdminPanel, user)} ${
      language === UserLanguageEnum.EN
        ? `had ${total} payments!

<b>List of payments:</b>`
        : language === UserLanguageEnum.UA
          ? `—î –ø–ª–∞—Ç–µ–∂—ñ–≤: ${total}!
  
<b>–°–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂—ñ–≤:</b>`
          : `–µ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–µ–π: ${total}!

<b>–°–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π:</b>`
    }`;

    payments.forEach((p) => {
      text = text + getPaymentInfoText(language, p);

      if (p.promocode) {
        text =
          text +
          `
  Promo code: ${p.promocode.name}`;
      }
    });
  } else {
    text = `${getUserInfoText(
      language,
      isAdminPanel,
      user,
    )} ${getNoPaymentsInfoText(language)}`;
  }

  await bot.sendMessage(id, text, {
    parse_mode: 'HTML',
    reply_markup: {
      remove_keyboard: true,
      inline_keyboard: [
        [
          {
            text: `‚¨ÖÔ∏è ${
              language === UserLanguageEnum.EN
                ? 'Back'
                : language === UserLanguageEnum.UA
                  ? '–ù–∞–∑–∞–¥'
                  : '–ù–∞–∑–∞–¥'
            }`,
            callback_data: isAdminPanel ? 'AdminPanel' : 'MySubscription',
          },
        ],
      ],
    },
  });
};

const getPaymentInfoText = (language: UserLanguageEnum, p: Payment) => {
  switch (language) {
    case UserLanguageEnum.EN:
      return `

- <b>Amount:</b> ${p.amount}$ 
  <b>Subscription plan:</b> ${p.subscription_plan[`name${language}`]}
  <b>Status:</b> ${getStatusText(language, p.status)}
  <b>Date:</b> ${p.created_date}
  <b>Expired date:</b> ${p.expired_date}`;

    case UserLanguageEnum.UA:
      return `

- <b>–°—É–º–∞:</b> ${p.amount}$
  <b>–ü–ª–∞–Ω –ø—ñ–¥–ø–∏—Å–∫–∏:</b> ${p.subscription_plan[`name${language}`]}
  <b>–°—Ç–∞—Ç—É—Å:</b> ${getStatusText(language, p.status)}
  <b>–î–∞—Ç–∞:</b> ${p.created_date}
  <b>–î–∞—Ç–∞ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è:</b> ${p.expired_date}`;

    case UserLanguageEnum.RU:
      return `

- <b>–°—É–º–º–∞:</b> ${p.amount}$
  <b>–ü–ª–∞–Ω –ø–æ–¥–ø–∏—Å–∫–∏:</b> ${p.subscription_plan[`name${language}`]}
  <b>–°—Ç–∞—Ç—É—Å:</b> ${getStatusText(language, p.status)}
  <b>–î–∞—Ç–∞:</b> ${p.created_date}
  <b>–î–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞:</b> ${p.expired_date}`;
  }
};

const getUserInfoText = (
  language: UserLanguageEnum,
  isAdminPanel: boolean,
  user: User,
) => {
  switch (language) {
    case UserLanguageEnum.EN:
      return isAdminPanel ? `User ${user.name}` : 'You';

    case UserLanguageEnum.UA:
      return isAdminPanel ? `–£ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${user.name}` : '–£ –≤–∞—Å';

    case UserLanguageEnum.RU:
      return isAdminPanel ? `–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.name}` : '–£ –≤–∞—Å';
  }
};

const getNoPaymentsInfoText = (language: UserLanguageEnum) => {
  switch (language) {
    case UserLanguageEnum.EN:
      return `haven't payments yet.`;

    case UserLanguageEnum.UA:
      return `—â–µ –Ω–µ –º–∞—î –ø–ª–∞—Ç–µ–∂—ñ–≤.`;

    case UserLanguageEnum.RU:
      return `–µ—â–µ –Ω–µ—Ç—É –ø–ª–∞—Ç–µ–∂–µ–π.`;
  }
};

const getStatusText = (
  language: UserLanguageEnum,
  status: PaymentStatusEnum,
) => {
  switch (status) {
    case PaymentStatusEnum.Cancel:
      return language === UserLanguageEnum.EN
        ? 'Your payment has not been confirmed by the manager'
        : language === UserLanguageEnum.UA
          ? '–í–∞—à –ø–ª–∞—Ç—ñ–∂ –Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º'
          : '–í–∞—à –ø–ª–∞—Ç–µ–∂ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º';

    case PaymentStatusEnum.Pending:
      return language === UserLanguageEnum.EN
        ? 'Your payment is still pending'
        : language === UserLanguageEnum.UA
          ? '–í–∞—à –ø–ª–∞—Ç—ñ–∂ —â–µ –æ—á—ñ–∫—É—î —Ä–æ–∑–≥–ª—è–¥—É'
          : '–í–∞—à –ø–ª–∞—Ç–µ–∂ –µ—â–µ –æ–∂–∏–¥–∞–µ—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è';

    case PaymentStatusEnum.Success:
      return language === UserLanguageEnum.EN
        ? 'Your payment is successful'
        : language === UserLanguageEnum.UA
          ? '–í–∞—à –ø–ª–∞—Ç—ñ–∂ —É—Å–ø—ñ—à–Ω–∏–π'
          : '–í–∞—à –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω';
  }
};
